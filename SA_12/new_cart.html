<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
</head>
<body style="background-color: #f8f5f4;">
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" style="background-color: rgba(77,78,84,1);">
        <div class="container" style="height:62px; width: 1170px; margin-right: auto;margin-left: auto;"> 
          <a class="navbar-brand" href="browse.html" style="color:#FFFFFF; font-weight: 600; font-size: 24px;">Tour<span style="color:rgb(0, 216, 255);">Nest</span></a>


            <ul class="navbar-nav    ms-auto">
            
             
              
            </ul>
        

        </div>
      </nav>

      <div class="container px-5" style="color: #2a2a2e;">
          <div class=""  style="background-color: #fcfcfc; padding-top: 110px;">
              <div class="row ps-5 gx-5">
                  <div class="col-md-7 ">
                    <div class="">
                        <h4 class="mb-3 fw-bold">個人資訊</h4>
                        <hr class="mb-4">
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <label for="lastName">姓<span style="color:red; font-weight: 900;">  *</span></label>
                          <input type="text" class="form-control" id="last_name" maxlength="10" value="" required="">
                        </div>
          
                        <div class="col-md-6 mb-4">
                          <label for="firstName">名<span style="color:red; font-weight: 900;">  *</span></label>
                          <input type="text" class="form-control" id="first_name" maxlength="10" placeholder="" value="" required="">
                        </div>
                      </div>
          
                      <div class="mb-4">
                        <label for="email" class="mb-1">Email <span class="text-muted">(Optional)<span style="color:red; font-weight: 900;">  *</span></span></label>
                        <input type="email" class="form-control" maxlength="50" id="email" placeholder="you@example.com">
                      </div>
          
                      <div class="mb-4">
                        <label for="address" class="mb-1">確認Email<span style="color:red; font-weight: 900;">  *</span></label>
                        <input type="text" class="form-control" id="emailconfirm" maxlength="255" placeholder="再次輸入Email" required="">
                      </div>
                      
                      <h4 class="mt-3 mb-3 fw-bold">付款方式</h4>
                        <hr class="mb-4">
                      
                      <form name="form1" method="post" action="">  
                      <div class="row pb-3">
                          <div class="col-md-3 mb-2">
                            <label for="address">線上付款</label>
                            <input type="radio" name="pay" value="onlinepay">
                          </div>
                          <div class="col-md-3 mb-2">
                            <label for="address">到場付款</label>
                            <input type="radio" name="pay" value="scenepay">
                            </div>
                      </div>
                      </form>
                      <h4 class="mt-1 mb-3 fw-bold">優惠券</h4>
                        <hr class="mb-4">
                      
                      <form name="form2" method="post" action="">  
                      <div class="row">
                          <div class="col-md-3 mb-2">
                            <label for="coupon">優惠碼</label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <input type="text" class="form-control" style="width: 130px; line-height: 1.5px;" id="coupon" size="50" value="">
                                </div>
                                <div class="col-md-6 mb-4" style="padding-left: 70px;">
                                    <button id="coupon_check" class="btn btn-secondary btn-sm btn-block fw-bold" style="width:100px;" ; type="button">確認優惠碼</button>
                                </div>
                            </div>
                          </div>
                      </div>
                      </form>
          
                     
          
                    </div>
                  </div>
                 
                  <div class="col-md-5 ">
                    <div class="bg-white border ps-3 py-3 mb-4" id="image_panel" style="width: 411px;">
                        
                        
                    </div>
                    <div class="bg-white border ps-3 py-3 " style="width: 411px;">
                        <div class="row">
                            <div class="col-3">
                                <p class="fw-bold" style="font-size: medium;">名稱</p>
                            </div>
                            <div class="col-9">
                                <p class="fw-bold" id="name_panel" style="font-size: medium;"> </p>
                            </div>
                            
                            <div class="col-3">
                                <p class="fw-bold" style="font-size: medium;">入住日期</p>
                            </div>
                            
                            <div class="col-9">
                                <!-- <p class="fw-bold" style="font-size: medium;">2022-04-11</p> -->
                                <input type="text" id="datepicker1" readonly='true'>
                            </div>
                            <div class="col-3">
                                <p class="fw-bold" style="font-size: medium;">退房日期</p>
                            </div>
                            <div class="col-9">
                                <!-- <p class="fw-bold" style="font-size: medium;">2022-04-15</p> -->
                                <input type="text" id="datepicker2" readonly='true'>
                            </div>
                            <div class="col-3">
                                <p class="fw-bold" style="font-size: medium;">價格/天</p>
                            </div>
                            <div class="col-9">
                                <p class="fw-bold" id="price_panel" style="font-size: medium;"> </p>
                            </div>
                            <!--  <div class="col-3">
                                <p class="fw-bold" style="font-size: medium;">人數</p>
                            </div>
                            <div class="col-9">
                                <p class="fw-bold" style="font-size: medium;">4人</p>
                            </div>-->
                        </div>
                        
                    </div>
                    
                    <div class="pt-4" id="next" style="padding-left: 0px;">
                        
                    </div>
                    
                  </div>
              </div>
          </div>
      </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script type="text/javascript">

	var url_string = window.location.href;
	var url = new URL(url_string);
	var id = url.searchParams.get("id");
	var manager_id = url.searchParams.get("manager_id");
	var room_name = url.searchParams.get("room_name");
	
	
	
	function getProductData() {
		
		$.ajax({
	        type: "GET",
	        url: "api/product.do",
	        data: "id=" + id,
	        crossDomain: true,
	        cache: false,
	        dataType: 'json',
	        timeout: 5000,
	        success: function (response) {
	            if(response.status == 200){
	            	$.each(response.response.data, function (){
	                	
	                  	$("#image_panel").append(addImage(this));
	                  	$("#name_panel").append(addName(this));
	                    $("#price_panel").append(addPrice(this));
						$("#next").append(addButton(this));
	                  
						sessionStorage.setItem("price",addPrice(this));
						sessionStorage.setItem("discount_price",addPrice(this));
	            	})	            	
	            }
	            
	        },
	        error: function () {
	            alert("無法連線到伺服器！");
	        }
	  });
		
	}

	function addImage(data){
		let inner_html = '';
		inner_html += '<div style="height: 225px; width: 375px; background-image: url('+data.image+'); background-position: center; background-size: cover;">'
		inner_html += '</div>'
        
		return inner_html;
	}
	
	function addName(data){
		return data.name;
	}
	
	function addPrice(data){
		return data.price;
	}
	
	function addButton(data){
		let inner_html = '';
		inner_html += '<a onclick="nextpage()" id="nextpage" type="button" class="btn btn-secondary fw-bold" style="width: 170px;">下一步</a>'
		return inner_html;
	}
	
	getProductData();
	console.log($("#next").html());
	
	//下一步
	function nextpage(){
		/*let inner_html = '';
		inner_html += 'new_card.html?id='+id+'&last_name='+$("#last_name").val()+'&first_name='+$("#first_name").val()+'&email='+$("#email").val()
		window.location.href= 'new_card.html?id='+id+'&manager_id='+manager_id+'&room_name='+room_name+'&last_name='+$("#last_name").val()+'&first_name='+$("#first_name").val()+'&email='+$("#email").val()+'&checkin='+$("#datepicker1").val()+'&checkout='+$("#datepicker2").val();*/
		var data = {
    			"first_name": $("#first_name").val(),
    			"last_name": $("#last_name").val(),
    			"email": $("#email").val(),
    			"emailconfirm": $("#emailconfirm").val(),
    			"checkin": $("#datepicker1").val(),
    			"checkout": $("#datepicker2").val()
    		}
	
		pass_vaild = vaildData(data);
    	if (pass_vaild) {
    		//var data_string = JSON.stringify(data);
    		
    		sessionStorage.setItem("last_name",$("#last_name").val());
    		sessionStorage.setItem("first_name",$("#first_name").val());
    		sessionStorage.setItem("email",$("#email").val());
    		sessionStorage.setItem("coupon",$("#coupon").val());
    		sessionStorage.setItem("checkin",$("#datepicker1").val());
    		sessionStorage.setItem("checkout",$("#datepicker2").val());
    		
		
			if ($('input[name="pay"]:checked').val()=='onlinepay'){
				location.href = 'new_onlinepay.html?id='+id+'&manager_id='+manager_id+'&room_name='+room_name;
			}
			else if($('input[name="pay"]:checked').val()=='scenepay'){
				location.href = 'new_scenepay.html?id='+id+'&manager_id='+manager_id+'&room_name='+room_name;
			}
			else{
				alert("請選擇付款方式");
			}
    	}                
	};
	
	function vaildData(data) {
    	var email_rule = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;
    	var phone_rule = /^09\d{2}-\d{3}-\d{3}$/;
    	

    	if (data["first_name"] == "" || data["last_name"] == "" || data['email'] == "" || data['emailconfirm'] == "" )  alert("必填寫欄位不得有空值！");
    	else if( data['checkin'] == "" || data['checkout'] == "") alert("請選擇入住及退房日期");
    	else if (data['email'] != "" && !email_rule.test(data['email'])) alert("Email格式不符！");
    	else if (data['email']!= data['emailconfirm']){
    		alert("email確認錯誤");
    	}
    	else return true;

    	return false;
    }
	
	//確認優惠碼
	$("#coupon_check").click(function () {
	    	
	    	var data = {
	    			"coupon": $("#coupon").val(),
	    	}
	    	if(data["coupon"] == ""){alert("請填寫優惠碼!");}
	    	else {
	    		coupon_check();
	    	}
	    	
	    });
    
    function coupon_check() {
        $.ajax({
          type: "GET",
          url: "api/CouponController.do",
          crossDomain: true,
          cache: false,
          data: "coupon=" + $("#coupon").val(),
          dataType: 'json',
          timeout: 5000,
          success: function (response) {
            if (response.status == 200) {
            	if(response.response.data!=""){ 
	          	  
				  
	          	  console.log(response.response.data);
	          	  $.each(response.response.data,function (index,value){
	          		  var now=new Date();
	          		  var start = new Date(value.start_time);
	          		  var end = new Date(value.end_time);
	          		  if(start<=now && now<=end){
	          			  
			          	  calDiscount(value.discount);
			          	  
			          	  alert("成功使用優惠碼");
	          		  }
	          		  else{
	          			  alert("優惠碼已過期");
	          		  }
	          	  });
            	}
            	else{
            		alert("優惠碼無效");
            	}
            }
          },
          error: function () {
            alert("無法連線到伺服器！");
          }
        });
      }
    function calDiscount(discount){
    	
    	var temp_price = sessionStorage.getItem("price");;

    	//$("#summary").html(total_price.toFixed(2));
    	total = parseFloat(temp_price)*discount;
    	$("#price_panel").empty();
    	$("#price_panel").append(total.toFixed(0));
    	sessionStorage.setItem("discount_price",total);
    	//$("#coupon_check").attr("disabled", true);
    	//$("#coupon").attr("disabled", true);
    }
    
    $( function() {
        $( "#datepicker1" ).datepicker();
        $( "#datepicker2" ).datepicker();
      } );
    
    
</script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
</html>